<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資許你安全</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>資許你安全</h1>
            </div>
            <div class="main-buttons">
                <ul>
                    <a href="/profile/index_login.html#home">首頁</a></li>
                    <a href="/profile/index_login.html#about">關於我們</a></li>
                    <a href="/profile/index_login.html#services">服務</a></li>
                    <a href="/profile/learn_status.html">學習歷程分析</a></li>
                    <a href="/profile/exam.html">測驗</a></li>
                    <a href="logout.html">登出</a></li>
                </ul>
            </div>
        </div>
    </header>

    <main class="main-content">
        <section class="section query-section">
            <div class="container">
                <h2>資料庫查詢系統</h2>
                <div class="query-container">
                    <form id="query-form" class="query-form">
                        <label for="table">選擇資料表:</label>
                        <select id="table" name="table">
                            <option value="users">使用者</option>
                            <option value="products">產品</option>
                            <option value="orders">訂單</option>
                        </select>
                        <label for="query">查詢語句 (SQL):</label>
                        <textarea id="query" name="query" rows="4" placeholder="請輸入您的 SQL 查詢 (例如: SELECT * FROM users)"></textarea>
                        <button type="submit">執行查詢</button>
                    </form>
                    <div id="results-container" style="display:none;">
                        <h3>查詢結果:</h3>
                        <div id="results"></div>
                    </div>
                    <div id="error-container" style="display:none; color: red;">
                        <h3>錯誤訊息:</h3>
                        <div id="error"></div>
                    </div>
                    <button id="add-record" class="add-button" style="display:none;">新增使用者</button>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>資許你安全</h2>
                    <p>沉浸式學習，資安教育</p>
                </div>
                <div class="footer-links">
                    <h3>快速導覽</h3>
                    <ul>
                        <li><a href="/profile/index_login.html#home">首頁</a></li>
                        <li><a href="/profile/index_login.html#about">關於我們</a></li>
                        <li><a href="/profile/index_login.html#services">服務</a></li>
                        <li><a href="/profile/learn_status.html">學習歷程分析</a></li>
                        <li><a href="/profile/exam.html">測驗</a></li>
                        <li><a href="logout.html">登出</a></li>
                    </ul>
                </div>
                <div class="footer-social">
                    <h3>關注我們</h3>
                    <div class="social-icons">
                        <a href="#" class="social-icon"><img src="/static/images/facebook.svg" alt="Facebook"></a>
                        <a href="#" class="social-icon"><img src="/static/images/twitter.svg" alt="Twitter"></a>
                        <a href="#" class="social-icon"><img src="/static/images/instagram.svg" alt="Instagram"></a>
                        <a href="#" class="social-icon"><img src="/static/images/linkedin.svg" alt="LinkedIn"></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 淡江資管. 保留所有權利.</p>
            </div>
        </div>
    </footer>

    <script>
        // 這裡可以放上您需要的 JavaScript 程式碼
        const queryForm = document.getElementById('query-form');
        const resultsContainer = document.getElementById('results-container');
        const resultsDiv = document.getElementById('results');
        const errorContainer = document.getElementById('error-container');
        const errorDiv = document.getElementById('error');
        const tableSelect = document.getElementById('table');
        const addRecordButton = document.getElementById('add-record');

        let editingRowId = null; // 用於追蹤正在編輯的列的 ID

        // 頁面載入時執行查詢
        window.onload = function() {
            tableSelect.value = 'users'; // 預設選擇 users 資料表
            const initialQuery = 'SELECT * FROM users';
            document.getElementById('query').value = initialQuery;
            executeQuery(initialQuery);
        };

        queryForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const query = document.getElementById('query').value;
            executeQuery(query);
        });

        tableSelect.addEventListener('change', () => {
            resultsDiv.innerHTML = '';
            resultsContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            editingRowId = null;
            addRecordButton.style.display = 'none';

            const selectedTable = tableSelect.value;
            let defaultQuery = '';
            if (selectedTable === 'users') {
                defaultQuery = 'SELECT * FROM users';
                addRecordButton.style.display = 'block';
            } else if (selectedTable === 'products') {
                defaultQuery = 'SELECT * FROM products';
                addRecordButton.style.display = 'none';
            } else if (selectedTable === 'orders') {
                defaultQuery = 'SELECT * FROM orders';
                addRecordButton.style.display = 'none';
            }
            document.getElementById('query').value = defaultQuery;
        });

        function executeQuery(query) {
            // 模擬後端處理 (您需要將此部分替換為實際的後端 API 呼叫)
            // 這是一個模擬的例子，實際的資料庫查詢應該在伺服器端進行
            let mockResults = [];
            let mockError = null;

            resultsDiv.innerHTML = ''; // 清空之前的結果
            errorDiv.innerHTML = '';
            errorContainer.style.display = 'none';
            editingRowId = null;

            try {
                // 簡單的模擬不同資料表的查詢
                if (query.toLowerCase().startsWith('select')) {
                    if (query.toLowerCase().includes('from users')) {
                        mockResults = [
                            { id: 1, name: 'John Doe', email: 'john.doe@example.com', role: 'user' },
                            { id: 2, name: 'Jane Smith', email: 'jane.smith@example.com', role: 'admin' },
                        ];
                    } else if (query.toLowerCase().includes('from products')) {
                        mockResults = [
                            { id: 101, name: 'Laptop', price: 1200 },
                            { id: 102, name: 'Mouse', price: 25 },
                        ];
                    } else if (query.toLowerCase().includes('from orders')) {
                        mockResults = [
                            { id: 1001, user_id: 1, product_id: 101, quantity: 2, order_date: '2024-07-24' },
                            { id: 1002, user_id: 2, product_id: 102, quantity: 5, order_date: '2024-07-24' },
                        ];
                    }
                    else {
                        mockError = "指定的資料表不存在";
                    }
                } else if (query.toLowerCase().startsWith('insert')) {
                    mockResults = [{ message: 'Record inserted successfully' }];
                } else if (query.toLowerCase().startsWith('update')) {
                    mockResults = [{ message: 'Record updated successfully' }];
                } else if (query.toLowerCase().startsWith('delete')) {
                    mockResults = [{ message: 'Record deleted successfully' }];
                }
                 else {
                    mockError = "只支援 SELECT, INSERT, UPDATE, DELETE 查詢";
                }
            } catch (e) {
                mockError = e.message;
            }

            if (mockError) {
                errorDiv.textContent = mockError;
                errorContainer.style.display = 'block';
                resultsContainer.style.display = 'none';
            } else if (mockResults.length > 0) {
                // 將結果顯示在網頁上
                let tableHtml = '<table>';
                const headers = Object.keys(mockResults[0]);
                tableHtml += '<tr>' + headers.map(header => `<th>${header}</th>`).join('');
                if (tableSelect.value === 'users') {
                    tableHtml += '<th>操作</th>'; // 為使用者資料表新增操作欄位
                }
                tableHtml += '</tr>';

                mockResults.forEach(row => {
                    const rowData = Object.values(row);
                    let rowHtml = `<tr data-id="${row.id}">`;
                    rowData.forEach(data => {
                        rowHtml += `<td>${data}</td>`;
                    });
                    if (tableSelect.value === 'users') {
                        rowHtml += `
                            <td>
                                <button class="edit-button">編輯</button>
                                <button class="delete-button">刪除</button>
                            </td>
                        `;
                    }
                    rowHtml += '</tr>';
                    tableHtml += rowHtml;
                });
                tableHtml += '</table>';
                resultsDiv.innerHTML = tableHtml;
                resultsContainer.style.display = 'block';
                errorContainer.style.display = 'none';
            }
            else {
                resultsDiv.innerHTML = "查無資料";
                resultsContainer.style.display = 'block';
                errorContainer.style.display = 'none';
            }
        }

        // 事件委派來處理動態新增的編輯和刪除按鈕的點擊事件
        resultsDiv.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-button')) {
                handleEdit(event.target.closest('tr'));
            } else if (event.target.classList.contains('delete-button')) {
                handleDelete(event.target.closest('tr'));
            } else if (event.target.classList.contains('save-button')) {
                handleSave(event.target.closest('tr'));
            } else if (event.target.classList.contains('cancel-button')) {
                handleCancel(event.target.closest('tr'));
            }
        });

        function handleEdit(row) {
            if (editingRowId) {
                // 如果已經有其他列在編輯模式，先取消編輯
                const editingRow = document.querySelector(`tr[data-id="${editingRowId}"]`);
                if (editingRow) {
                    handleCancel(editingRow);
                }
            }

            editingRowId = row.dataset.id;
            row.classList.add('edit-mode');
            const cells = row.querySelectorAll('td:not(:last-child)'); // 排除操作按鈕所在的儲存格
            cells.forEach(cell => {
                const originalText = cell.textContent;
                cell.innerHTML = `<input type="text" value="${originalText}">`;
            });
            // 將編輯和刪除按鈕替換為儲存和取消按鈕
            const actionsCell = row.querySelector('td:last-child');
            actionsCell.innerHTML = `
                <button class="save-button">儲存</button>
                <button class="cancel-button">取消</button>
            `;
        }

        function handleSave(row) {
            const cells = row.querySelectorAll('td:not(:last-child)');
            const updatedData = {};
            const headers = Array.from(document.querySelectorAll('#results-container table th')).map(th => th.textContent);
            headers.pop(); // 移除 "操作" 標題

            cells.forEach((cell, index) => {
                const input = cell.querySelector('input');
                updatedData[headers[index]] = input ? input.value : cell.textContent;
                cell.textContent = input ? input.value : cell.textContent;
            });

             // 模擬後端更新 (您需要將此部分替換為實際的後端 API 呼叫)
             //  console.log('Updated data:', updatedData);
             //  console.log('Row ID:', row.dataset.id);

            row.classList.remove('edit-mode');
            editingRowId = null;

            // 重新執行查詢，以確保顯示最新的資料
            const currentQuery = document.getElementById('query').value;
            executeQuery(currentQuery);
        }

        function handleCancel(row) {
            row.classList.remove('edit-mode');
            editingRowId = null;
            // 重新執行查詢，以恢復原始資料
            const currentQuery = document.getElementById('query').value;
            executeQuery(currentQuery);
        }

        function handleDelete(row) {
            const rowId = row.dataset.id;
            // 模擬後端刪除 (您需要將此部分替換為實際的後端 API 呼叫)
            // console.log('Delete row with ID:', rowId);

            row.remove(); // 從 DOM 中移除列
            resultsContainer.style.display = 'none'; //如果刪除最後一筆，隱藏 resultsContainer
            editingRowId = null;

            // 重新執行查詢，以確保顯示最新的資料
            const currentQuery = document.getElementById('query').value;
            executeQuery(currentQuery);
        }

        addRecordButton.addEventListener('click', () => {
            // 創建一個新的表單，讓使用者輸入新的使用者資料
            const formHtml = `
                <form id="add-user-form" class="query-form">
                    <label for="new-name">姓名:</label>
                    <input type="text" id="new-name" name="new-name" required>
                    <label for="new-email">電子郵件:</label>
                    <input type="email" id="new-email" name="new-email" required>
                    <label for="new-role">角色:</label>
                    <input type="text" id="new-role" name="new-role" value="user" required>
                    <button type="submit">新增</button>
                    <button type="button" id="cancel-add-user">取消</button>
                </form>
            `;

            resultsDiv.innerHTML = formHtml;
            resultsContainer.style.display = 'block';
            errorContainer.style.display = 'none';

            // 監聽新增表單的提交事件
            const addUserForm = document.getElementById('add-user-form');
            addUserForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const newName = document.getElementById('new-name').value;
                const newEmail = document.getElementById('new-email').value;
                const newRole = document.getElementById('new-role').value;

                // 模擬後端新增 (您需要將此部分替換為實際的後端 API 呼叫)
                //  console.log('New user:', { name: newName, email: newEmail, role: newRole });

                // 創建一個新的資料列
                const newRow = { id: Date.now(), name: newName, email: newEmail, role: newRole }; // 使用時間戳作為臨時 ID
                let tableHtml = '<table>';
                const headers = Object.keys(newRow);
                tableHtml += '<tr>' + headers.map(header => `<th>${header}</th>`).join('') + '<th>操作</th></tr>';
                const rowData = Object.values(newRow);
                tableHtml += `<tr data-id="${newRow.id}">` + rowData.map(data => `<td>${data}</td>`).join('') + `
                            <td>
                                <button class="edit-button">編輯</button>
                                <button class="delete-button">刪除</button>
                            </td>
                        </tr>`;
                tableHtml += '</table>';
                resultsDiv.innerHTML = tableHtml;
                resultsContainer.style.display = 'block';

                // 重新執行查詢，以確保顯示最新的資料
                const currentQuery = document.getElementById('query').value;
                executeQuery(currentQuery);
            });

            // 監聽取消按鈕的點擊事件
            const cancelAddUserButton = document.getElementById('cancel-add-user');
            cancelAddUserButton.addEventListener('click', () => {
                // 清空表單，恢復到查詢結果的顯示
                const currentQuery = document.getElementById('query').value;
                executeQuery(currentQuery);
            });
        });
    </script>
</body>
</html>
