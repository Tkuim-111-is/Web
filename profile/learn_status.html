<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學習歷程分析</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
</head>
<body>
    <header class="header">
        <div class="container">
          <div class="logo">
            <h1><a href="index.html#home">資許你安全</a></h1>
          </div>
          <nav class="main-nav" role="navigation" aria-label="主要導航">
            <ul>
                <li><a href="index.html#home">首頁</a></li>
                <li><a href="index.html#about">關於我們</a></li>
                <li><a href="index.html#services">服務</a></li>
                <li><a href="learn_status.html"  class="active" aria-current="page">學習歷程分析</a></li>
                <li><a href="/logout">登出</a></li>
            </ul>
          </nav>
        </div>
    </header>

    <section id="learning-analysis" class="learning-analysis">
        <div class="container">
            <br><br><br><br>
            <div class="chart-container">
                <h2>各情境錯誤次數</h2>
                <canvas id="errorCountChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>各情境學習時間</h2>
                <canvas id="timeChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>錯誤次數 vs 學習時間散佈圖</h2>
                <canvas id="scatterChart"></canvas>
            </div>
            <div class="summary-container">
                <h2>學習總結</h2>
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                                <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-scenarios">-</div>
                            <div class="stat-label">完成情境</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-time">-</div>
                            <div class="stat-label">總學習時間</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="perfect-scenarios">-</div>
                            <div class="stat-label">完美通關</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="avg-errors">-</div>
                            <div class="stat-label">平均錯誤次數</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-analysis">
                    <h3>學習表現分析</h3>
                    <div class="progress-bars">
                        <div class="progress-item">
                            <div class="progress-header">
                                <span>整體掌握度</span>
                                <span id="mastery-percentage">-</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="mastery-progress"></div>
                            </div>
                        </div>
                        
                        <div class="progress-item">
                            <div class="progress-header">
                                <span>效率指標</span>
                                <span id="efficiency-percentage">-</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="efficiency-progress"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="detailed-summary">
                    <h3>詳細總結</h3>
                    <div class="summary-text" id="summary-text">載入中...</div>
                    <div class="achievements" id="achievements-list">
                        <!-- 成就列表將在這裡動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>資許你安全</h2>
                    <p>沉浸式學習，資安教育</p>
                </div>
                <div class="footer-links">
                    <h3>快速導覽</h3>
                    <ul>
                        <li><a href="index.html#home">首頁</a></li>
                        <li><a href="index.html#about">關於我們</a></li>
                        <li><a href="index.html#services">服務</a></li>
                        <li><a href="learn_status.html"  class="active" aria-current="page">學習歷程分析</a></li>
                        <li><a href="/logout">登出</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>法律資訊</h3>
                    <ul>
                      <li><a href="/views/privacy.html">隱私權政策</a></li>
                      <li><a href="/views/tos.html">服務條款</a></li>
                    </ul>
                  </div>
                <div class="footer-social">
                    <h3>關注我們</h3>
                    <div class="social-icons">
                        <a href="https://github.com/Tkuim-111-is/Surecurity" class="social-icon"><img src="/static/images/github-mark-white.svg" alt="Github"></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 淡江資管. 保留所有權利.</p>
            </div>
        </div>
    </footer>

    <script>
        function isTokenExpired(token) {
        if (!token) return true;
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return Date.now() / 1000 > payload.exp;
        } catch {
            return true;
        }
        }

        const token = localStorage.getItem('token');
        if (!token || isTokenExpired(token)) {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // 取得學習歷程資料
        async function fetchLearnStatus() {
            try {
                const res = await fetch('/api/profile/learn_status', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                const result = await res.json();
                if (result.success) {
                    const data = result.data;
                    renderCharts(data);
                    updateSummary(data);
                } else {
                    document.getElementById('summary-text').innerText = '無法取得學習歷程資料';
                }
            } catch (e) {
                document.getElementById('summary-text').innerText = '載入學習歷程失敗';
                console.error('載入學習歷程失敗', e);
            }
        }

        // 時間格式化函數：秒 -> 分:秒
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Context ID 對應表
        const contextIdMapping = {
            2: '會議室管理',
            4: '無線網路安全',
            6: '外來裝置風險',
            71: '密碼強度',
            72: '機密文件管理',
            73: '資料外洩風險',
            74: '惡意網站',
            75: '釣魚郵件防範'
        };

        // Context ID 格式化函數：轉換為中文名稱
        function formatContextId(contextId) {
            return contextIdMapping[contextId] || `情境${contextId}`;
        }

        // 日期格式化函數：將 MySQL DATETIME 轉換為年月日格式
        function formatDate(dateString) {
            if (!dateString) return '未知時間';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (e) {
                return '無效時間';
            }
        }

        // 根據資料渲染圖表
        function renderCharts(data) {
            // context_id 代表關卡，err_count 代表錯誤次數，time_record 代表學習時間
            const contextLabels = [...new Set(data.map(row => row.context_id))];
            const formattedContextLabels = contextLabels.map(label => formatContextId(label));
            
            // 為每個 context 準備資料和完成時間
            const contextData = contextLabels.map(label => {
                const contextRows = data.filter(row => row.context_id === label);
                const totalTime = contextRows.reduce((sum, row) => sum + (row.time_record || 0), 0);
                const totalErrors = contextRows.reduce((sum, row) => sum + row.err_count, 0);
                
                // 找到最新的記錄（根據 created_at）
                const latestRecord = contextRows.reduce((latest, row) => {
                    return new Date(row.created_at) > new Date(latest.created_at) ? row : latest;
                }, contextRows[0]);
                
                // 找到最佳記錄（最少錯誤次數）
                const bestRecord = contextRows.reduce((best, row) => {
                    return row.err_count < best.err_count ? row : best;
                }, contextRows[0]);
                
                return {
                    contextId: label,
                    formattedId: formatContextId(label),
                    totalTime,
                    totalErrors,
                    completedAt: latestRecord.created_at,
                    latestErrorCount: latestRecord.err_count,  // 最新記錄的錯誤次數
                    bestErrorCount: bestRecord.err_count,      // 最佳記錄的錯誤次數
                    isPerfectLatest: latestRecord.err_count === 0,  // 最新記錄是否完美
                    isPerfectBest: bestRecord.err_count === 0       // 是否有完美記錄
                };
            });
            
            const learningTimes = contextData.map(item => item.totalTime);
            const errorRates = contextData.map(item => item.totalErrors);

            // 各關卡錯誤次數圖表
            new Chart(document.getElementById('errorCountChart'), {
                type: 'bar',
                data: {
                    labels: formattedContextLabels,
                    datasets: [{
                        label: '錯誤次數',
                        data: errorRates,
                        backgroundColor: '#f43f5e',
                        borderColor: '#b91c1c',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const contextInfo = contextData[index];
                                    return contextInfo.formattedId;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const contextInfo = contextData[index];
                                    const completedDate = formatDate(contextInfo.completedAt);
                                    return [
                                        `錯誤次數: ${context.parsed.y}`,
                                        `完成時間: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 各關卡學習時間圖表
            new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: {
                    labels: formattedContextLabels,
                    datasets: [{
                        label: '學習時間 (秒)',
                        data: learningTimes,
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const contextInfo = contextData[index];
                                    return contextInfo.formattedId;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const contextInfo = contextData[index];
                                    const seconds = context.parsed.y;
                                    const completedDate = formatDate(contextInfo.completedAt);
                                    return [
                                        `學習時間: ${formatTime(seconds)} (${seconds}秒)`,
                                        `完成時間: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatTime(value);
                                }
                            }
                        }
                    }
                }
            });

            // 錯誤次數 vs 學習時間散佈圖
            const scatterData = data.map(row => ({
                x: row.err_count,
                y: row.time_record,
                context_id: row.context_id
            }));

            // 按 context_id 分組顯示不同顏色
            const contexts = [...new Set(data.map(row => row.context_id))];
            const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#84cc16'];
            
            const scatterDatasets = contexts.map((context, index) => ({
                label: formatContextId(context),
                data: scatterData.filter(point => point.context_id === context),
                backgroundColor: colors[index % colors.length],
                borderColor: colors[index % colors.length],
                pointRadius: 8,
                pointHoverRadius: 10
            }));

            new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: {
                    datasets: scatterDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'bottom' 
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const datasetIndex = context[0].datasetIndex;
                                    const dataIndex = context[0].dataIndex;
                                    const dataset = scatterDatasets[datasetIndex];
                                    const dataPoint = dataset.data[dataIndex];
                                    const contextInfo = contextData.find(item => item.contextId === dataPoint.context_id);
                                    return contextInfo ? contextInfo.formattedId : formatContextId(dataPoint.context_id);
                                },
                                label: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const dataIndex = context.dataIndex;
                                    const dataset = scatterDatasets[datasetIndex];
                                    const dataPoint = dataset.data[dataIndex];
                                    const contextInfo = contextData.find(item => item.contextId === dataPoint.context_id);
                                    const point = context.parsed;
                                    const timeFormatted = formatTime(point.y);
                                    const completedDate = formatDate(contextInfo ? contextInfo.completedAt : '');
                                    return [
                                        `錯誤次數: ${point.x}`,
                                        `學習時間: ${timeFormatted} (${point.y}秒)`,
                                        `完成時間: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '錯誤次數 (err_count)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '學習時間 (time_record)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatTime(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新學習總結
        function updateSummary(data) {
            const totalTimeSeconds = data.reduce((sum, row) => sum + (row.time_record || 0), 0);
            const totalErr = data.reduce((sum, row) => sum + row.err_count, 0);
            const averageErrorRate = data.length > 0 ? (totalErr / data.length).toFixed(2) : 0;
            const totalTimeFormatted = formatTime(totalTimeSeconds);
            
            // 計算統計資料
            const contextLabels = [...new Set(data.map(row => row.context_id))];
            const totalScenarios = contextLabels.length;
            
            // 計算完美通關數量（錯誤次數為0的情境）
            const perfectScenarios = contextLabels.filter(contextId => {
                const contextRows = data.filter(row => row.context_id === contextId);
                const bestRecord = contextRows.reduce((best, row) => {
                    return row.err_count < best.err_count ? row : best;
                }, contextRows[0]);
                return bestRecord.err_count === 0;
            }).length;
            
            // 計算掌握度（基於錯誤次數）
            const masteryScore = totalScenarios > 0 ? Math.max(0, 100 - (averageErrorRate * 10)) : 0;
            
            // 計算效率指標（基於時間和錯誤次數的綜合評估）
            const avgTimePerScenario = totalScenarios > 0 ? totalTimeSeconds / totalScenarios : 0;
            const timeEfficiency = Math.max(0, 100 - (avgTimePerScenario / 60) * 5); // 假設理想時間為1分鐘
            const errorEfficiency = Math.max(0, 100 - averageErrorRate * 20);
            const overallEfficiency = (timeEfficiency + errorEfficiency) / 2;
            
            // 更新統計卡片
            document.getElementById('total-scenarios').textContent = totalScenarios;
            document.getElementById('total-time').textContent = totalTimeFormatted;
            document.getElementById('perfect-scenarios').textContent = `${perfectScenarios}/${totalScenarios}`;
            document.getElementById('avg-errors').textContent = averageErrorRate;
            
            // 更新進度條
            document.getElementById('mastery-percentage').textContent = `${Math.round(masteryScore)}%`;
            document.getElementById('mastery-progress').style.width = `${masteryScore}%`;
            
            document.getElementById('efficiency-percentage').textContent = `${Math.round(overallEfficiency)}%`;
            document.getElementById('efficiency-progress').style.width = `${overallEfficiency}%`;
            
            // 更新詳細總結文字
            const summaryText = generateDetailedSummary(data, totalTimeFormatted, averageErrorRate, totalScenarios, perfectScenarios, masteryScore, overallEfficiency);
            document.getElementById('summary-text').innerHTML = summaryText;
            
            // 生成成就列表
            generateAchievements(data, totalScenarios, perfectScenarios, totalTimeSeconds, averageErrorRate);
        }
        
        // 生成詳細總結文字
        function generateDetailedSummary(data, totalTime, avgErrors, totalScenarios, perfectScenarios, masteryScore, efficiency) {
            let summary = `<strong>學習概況：</strong><br>`;
            summary += `你總共完成了 <span style="color: var(--primary-600); font-weight: 700;">${totalScenarios}</span> 個資安情境的學習，`;
            summary += `累計學習時間為 <span style="color: var(--primary-600); font-weight: 700;">${totalTime}</span>。<br><br>`;
            
            summary += `<strong>表現分析：</strong><br>`;
            if (perfectScenarios > 0) {
                summary += `🎉 恭喜！你在 <span style="color: var(--success-600); font-weight: 700;">${perfectScenarios}</span> 個情境中達到了完美通關（零錯誤）！<br>`;
            }
            
            summary += `平均每個情境的錯誤次數為 <span style="color: ${avgErrors <= 1 ? 'var(--success-600)' : avgErrors <= 3 ? 'var(--warning-600)' : 'var(--danger-600)'}; font-weight: 700;">${avgErrors}</span> 次。<br><br>`;
            
            // 根據表現給出建議
            if (masteryScore >= 80) {
                summary += `<strong>🌟 優秀表現：</strong>你的掌握度達到了 ${Math.round(masteryScore)}%，表現非常出色！繼續保持這種學習態度。`;
            } else if (masteryScore >= 60) {
                summary += `<strong>📈 良好進步：</strong>你的掌握度為 ${Math.round(masteryScore)}%，已經有了不錯的基礎，建議多複習錯誤較多的情境。`;
            } else {
                summary += `<strong>💪 持續努力：</strong>你的掌握度為 ${Math.round(masteryScore)}%，還有很大的提升空間，建議重複練習並仔細閱讀相關資安知識。`;
            }
            
            return summary;
        }
        
        // 生成成就列表
        function generateAchievements(data, totalScenarios, perfectScenarios, totalTimeSeconds, avgErrors) {
            const achievementsContainer = document.getElementById('achievements-list');
            const achievements = [];
            
            // 完成情境成就
            if (totalScenarios >= 8) {
                achievements.push({
                    icon: '🏆',
                    type: 'gold',
                    text: '資安專家 - 完成所有學習情境'
                });
            } else if (totalScenarios >= 5) {
                achievements.push({
                    icon: '🥈',
                    type: 'silver', 
                    text: `情境探索者 - 完成 ${totalScenarios} 個學習情境`
                });
            } else if (totalScenarios >= 3) {
                achievements.push({
                    icon: '🥉',
                    type: 'bronze',
                    text: `學習新手 - 完成 ${totalScenarios} 個學習情境`
                });
            }
            
            // 完美通關成就
            if (perfectScenarios >= 5) {
                achievements.push({
                    icon: '⭐',
                    type: 'gold',
                    text: `完美主義者 - ${perfectScenarios} 次完美通關`
                });
            } else if (perfectScenarios >= 3) {
                achievements.push({
                    icon: '✨',
                    type: 'silver',
                    text: `精準射手 - ${perfectScenarios} 次完美通關`
                });
            } else if (perfectScenarios >= 1) {
                achievements.push({
                    icon: '💫',
                    type: 'bronze',
                    text: `初露鋒芒 - ${perfectScenarios} 次完美通關`
                });
            }
            
            // 學習時間成就
            const totalMinutes = Math.floor(totalTimeSeconds / 60);
            if (totalMinutes >= 60) {
                achievements.push({
                    icon: '⏰',
                    type: 'gold',
                    text: `學習馬拉松 - 累計學習超過 1 小時`
                });
            } else if (totalMinutes >= 30) {
                achievements.push({
                    icon: '🕐',
                    type: 'silver',
                    text: `專注學習者 - 累計學習超過 30 分鐘`
                });
            } else if (totalMinutes >= 10) {
                achievements.push({
                    icon: '⏱️',
                    type: 'bronze',
                    text: `時間投資者 - 累計學習超過 10 分鐘`
                });
            }
            
            // 錯誤率成就
            if (avgErrors <= 1) {
                achievements.push({
                    icon: '🎯',
                    type: 'gold',
                    text: '神射手 - 平均錯誤次數極低'
                });
            } else if (avgErrors <= 2) {
                achievements.push({
                    icon: '🏹',
                    type: 'silver',
                    text: '準確射手 - 平均錯誤次數較低'
                });
            }
            
            // 渲染成就
            if (achievements.length === 0) {
                achievementsContainer.innerHTML = '<p style="text-align: center; color: var(--gray-500); font-style: italic;">繼續學習以解鎖更多成就！</p>';
            } else {
                achievementsContainer.innerHTML = achievements.map(achievement => `
                    <div class="achievement-item">
                        <div class="achievement-icon ${achievement.type}">
                            ${achievement.icon}
                        </div>
                        <div class="achievement-text">
                            ${achievement.text}
                        </div>
                    </div>
                `).join('');
            }
        }

        // 初始化
        fetchLearnStatus();
    </script>
</body>
</html>