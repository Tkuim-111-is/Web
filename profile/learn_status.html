<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學習歷程分析</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>學習歷程分析</h1>
            </div>
            <div class="main-buttons">
                <ul>
                    <a href="/profile/index_login.html#home">首頁</a>
                    <a href="/profile/index_login.html#about">關於我們</a>
                    <a href="/profile/index_login.html#services">服務</a>
                    <a href="/profile/learn_status.html">學習歷程分析</a>
                    <a href="/profile/exam.html">測驗</a>
                    <a href="/logout">登出</a>
                </ul>
            </div>
        </div>
    </header>

    <section id="learning-analysis" class="learning-analysis">
        <div class="container">
            <br><br><br><br>
            <div class="chart-container">
                <h2>各情境錯誤次數</h2>
                <canvas id="errorCountChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>各情境學習時間</h2>
                <canvas id="timeChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>錯誤次數 vs 學習時間散佈圖</h2>
                <canvas id="scatterChart"></canvas>
            </div>
            <div class="summary-container">
                <h2>學習總結</h2>
                <p id="summary-text">載入中...</p>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>資許你安全</h2>
                    <p>沉浸式學習，資安教育</p>
                </div>
                <div class="footer-links">
                    <h3>快速導覽</h3>
                    <ul>
                        <li><a href="/profile/index_login.html#home">首頁</a></li>
                        <li><a href="/profile/index_login.html#about">關於我們</a></li>
                        <li><a href="/profile/index_login.html#services">服務</a></li>
                        <li><a href="/profile/learn_status.html">學習歷程分析</a></li>
                        <li><a href="/profile/exam.html">測驗</a></li>
                        <li><a href="/logout">登出</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>法律資訊</h3>
                    <ul>
                      <li><a href="privacy.html">隱私權政策</a></li>
                      <li><a href="tos.html">服務條款</a></li>
                    </ul>
                  </div>
                <div class="footer-social">
                    <h3>關注我們</h3>
                    <div class="social-icons">
                        <a href="https://github.com/Tkuim-111-is/Surecurity" class="social-icon"><img src="/static/images/github-mark.svg" alt="Github"></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 淡江資管. 保留所有權利.</p>
            </div>
        </div>
    </footer>

    <script>
        function isTokenExpired(token) {
        if (!token) return true;
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return Date.now() / 1000 > payload.exp;
        } catch {
            return true;
        }
        }

        const token = localStorage.getItem('token');
        if (!token || isTokenExpired(token)) {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // 取得學習歷程資料
        async function fetchLearnStatus() {
            try {
                const res = await fetch('/api/profile/learn_status', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                const result = await res.json();
                if (result.success) {
                    const data = result.data;
                    renderCharts(data);
                    updateSummary(data);
                } else {
                    document.getElementById('summary-text').innerText = '無法取得學習歷程資料';
                }
            } catch (e) {
                document.getElementById('summary-text').innerText = '載入學習歷程失敗';
                console.error('載入學習歷程失敗', e);
            }
        }

        // 時間格式化函數：秒 -> 分:秒
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Context ID 格式化函數：兩位數轉換為帶連字號格式
        function formatContextId(contextId) {
            const contextStr = contextId.toString();
            // 檢查是否為兩位數
            if (contextStr.length === 2 && /^\d{2}$/.test(contextStr)) {
                return `${contextStr[0]}-${contextStr[1]}`;
            }
            return contextStr;
        }

        // 日期格式化函數：將 MySQL DATETIME 轉換為年月日格式
        function formatDate(dateString) {
            if (!dateString) return '未知時間';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (e) {
                return '無效時間';
            }
        }

        // 根據資料渲染圖表
        function renderCharts(data) {
            // context_id 代表關卡，err_count 代表錯誤次數，time_record 代表學習時間
            const contextLabels = [...new Set(data.map(row => row.context_id))];
            const formattedContextLabels = contextLabels.map(label => formatContextId(label));
            
            // 為每個 context 準備資料和完成時間
            const contextData = contextLabels.map(label => {
                const contextRows = data.filter(row => row.context_id === label);
                const totalTime = contextRows.reduce((sum, row) => sum + (row.time_record || 0), 0);
                const totalErrors = contextRows.reduce((sum, row) => sum + row.err_count, 0);
                // 取最新的完成時間
                const latestCreatedAt = contextRows.reduce((latest, row) => {
                    return new Date(row.created_at) > new Date(latest) ? row.created_at : latest;
                }, contextRows[0]?.created_at || '');
                
                return {
                    contextId: label,
                    formattedId: formatContextId(label),
                    totalTime,
                    totalErrors,
                    completedAt: latestCreatedAt
                };
            });
            
            const learningTimes = contextData.map(item => item.totalTime);
            const errorRates = contextData.map(item => item.totalErrors);

            // 各關卡錯誤次數圖表
            new Chart(document.getElementById('errorCountChart'), {
                type: 'bar',
                data: {
                    labels: formattedContextLabels,
                    datasets: [{
                        label: '錯誤次數',
                        data: errorRates,
                        backgroundColor: '#f43f5e',
                        borderColor: '#b91c1c',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const contextInfo = contextData[index];
                                    return `情境${contextInfo.formattedId}`;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const contextInfo = contextData[index];
                                    const completedDate = formatDate(contextInfo.completedAt);
                                    return [
                                        `錯誤次數: ${context.parsed.y}`,
                                        `完成時間: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 各關卡學習時間圖表
            new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: {
                    labels: formattedContextLabels,
                    datasets: [{
                        label: '學習時間 (秒)',
                        data: learningTimes,
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const contextInfo = contextData[index];
                                    return `情境${contextInfo.formattedId}`;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const contextInfo = contextData[index];
                                    const seconds = context.parsed.y;
                                    const completedDate = formatDate(contextInfo.completedAt);
                                    return [
                                        `學習時間: ${formatTime(seconds)} (${seconds}秒)`,
                                        `完成時間: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatTime(value);
                                }
                            }
                        }
                    }
                }
            });

            // 錯誤次數 vs 學習時間散佈圖
            const scatterData = data.map(row => ({
                x: row.err_count,
                y: row.time_record,
                context_id: row.context_id
            }));

            // 按 context_id 分組顯示不同顏色
            const contexts = [...new Set(data.map(row => row.context_id))];
            const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#84cc16'];
            
            const scatterDatasets = contexts.map((context, index) => ({
                label: `Context ${formatContextId(context)}`,
                data: scatterData.filter(point => point.context_id === context),
                backgroundColor: colors[index % colors.length],
                borderColor: colors[index % colors.length],
                pointRadius: 8,
                pointHoverRadius: 10
            }));

            new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: {
                    datasets: scatterDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'bottom' 
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const datasetIndex = context[0].datasetIndex;
                                    const dataIndex = context[0].dataIndex;
                                    const dataset = scatterDatasets[datasetIndex];
                                    const dataPoint = dataset.data[dataIndex];
                                    const contextInfo = contextData.find(item => item.contextId === dataPoint.context_id);
                                    return `情境${contextInfo ? contextInfo.formattedId : dataPoint.context_id}`;
                                },
                                label: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const dataIndex = context.dataIndex;
                                    const dataset = scatterDatasets[datasetIndex];
                                    const dataPoint = dataset.data[dataIndex];
                                    const contextInfo = contextData.find(item => item.contextId === dataPoint.context_id);
                                    const point = context.parsed;
                                    const timeFormatted = formatTime(point.y);
                                    const completedDate = formatDate(contextInfo ? contextInfo.completedAt : '');
                                    return [
                                        `錯誤次數: ${point.x}`,
                                        `學習時間: ${timeFormatted} (${point.y}秒)`,
                                        `完成時間: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '錯誤次數 (err_count)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '學習時間 (time_record)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatTime(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新學習總結
        function updateSummary(data) {
            const totalTimeSeconds = data.reduce((sum, row) => sum + (row.time_record || 0), 0);
            const totalErr = data.reduce((sum, row) => sum + row.err_count, 0);
            const averageErrorRate = data.length > 0 ? (totalErr / data.length).toFixed(2) : 0;
            const totalTimeFormatted = formatTime(totalTimeSeconds);
            
            document.getElementById('summary-text').innerText =
                `你總共花了 ${totalTimeFormatted} 學習，平均錯誤次數為 ${averageErrorRate}。`;
        }

        // 初始化
        fetchLearnStatus();
    </script>
</body>
</html>