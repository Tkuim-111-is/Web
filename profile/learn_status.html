<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’æ­·ç¨‹åˆ†æ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
</head>
<body>
    <header class="header">
        <div class="container">
          <div class="logo">
            <h1><a href="index.html#home">è³‡è¨±ä½ å®‰å…¨</a></h1>
          </div>
          <nav class="main-nav" role="navigation" aria-label="ä¸»è¦å°èˆª">
            <ul>
                <li><a href="index.html#home">é¦–é </a></li>
                <li><a href="index.html#about">é—œæ–¼æˆ‘å€‘</a></li>
                <li><a href="index.html#services">æœå‹™</a></li>
                <li><a href="learn_status.html"  class="active" aria-current="page">å­¸ç¿’æ­·ç¨‹åˆ†æ</a></li>
                <li><a href="/logout">ç™»å‡º</a></li>
            </ul>
          </nav>
        </div>
    </header>

    <section id="learning-analysis" class="learning-analysis">
        <div class="container">
            <br><br><br><br>
            <div class="chart-container">
                <h2>å„æƒ…å¢ƒéŒ¯èª¤æ¬¡æ•¸</h2>
                <canvas id="errorCountChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>å„æƒ…å¢ƒå­¸ç¿’æ™‚é–“</h2>
                <canvas id="timeChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>éŒ¯èª¤æ¬¡æ•¸ vs å­¸ç¿’æ™‚é–“æ•£ä½ˆåœ–</h2>
                <canvas id="scatterChart"></canvas>
            </div>
            <div class="summary-container">
                <h2>å­¸ç¿’ç¸½çµ</h2>
                
                <!-- ç¸½è¦½çµ±è¨ˆè¡¨æ ¼ -->
                <div class="summary-table-section">
                    <h3>å­¸ç¿’çµ±è¨ˆç¸½è¦½</h3>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>çµ±è¨ˆé …ç›®</th>
                                <th>æ•¸å€¼</th>
                                <th>è©•ç´š</th>
                                <th>èªªæ˜</th>
                            </tr>
                        </thead>
                        <tbody id="summary-stats-table">
                            <!-- çµ±è¨ˆè³‡æ–™å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                
                <!-- å„æƒ…å¢ƒè©³ç´°è¡¨æ ¼ -->
                <div class="scenarios-table-section">
                    <h3>å„æƒ…å¢ƒå­¸ç¿’è©³æƒ…</h3>
                    <table class="scenarios-table">
                        <thead>
                            <tr>
                                <th>æƒ…å¢ƒåç¨±</th>
                                <th>å®Œæˆæ¬¡æ•¸</th>
                                <th>æœ€ä½³éŒ¯èª¤æ¬¡æ•¸</th>
                                <th>æœ€æ–°éŒ¯èª¤æ¬¡æ•¸</th>
                                <th>ç¸½å­¸ç¿’æ™‚é–“</th>
                                <th>æœ€å¾Œå®Œæˆæ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="scenarios-details-table">
                            <!-- æƒ…å¢ƒè©³æƒ…å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                
                <!-- æˆå°±è¡¨æ ¼ -->
                <div class="achievements-table-section">
                    <h3>å­¸ç¿’æˆå°±</h3>
                    <table class="achievements-table">
                        <thead>
                            <tr>
                                <th>æˆå°±é¡å‹</th>
                                <th>æˆå°±åç¨±</th>
                                <th>ç­‰ç´š</th>
                                <th>ç²å¾—æ¢ä»¶</th>
                            </tr>
                        </thead>
                        <tbody id="achievements-table">
                            <!-- æˆå°±åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                
                <!-- å­¸ç¿’å»ºè­° -->
                <div class="recommendations-section">
                    <h3>å­¸ç¿’å»ºè­°</h3>
                    <div class="recommendation-text" id="recommendation-text">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>è³‡è¨±ä½ å®‰å…¨</h2>
                    <p>æ²‰æµ¸å¼å­¸ç¿’ï¼Œè³‡å®‰æ•™è‚²</p>
                </div>
                <div class="footer-links">
                    <h3>å¿«é€Ÿå°è¦½</h3>
                    <ul>
                        <li><a href="index.html#home">é¦–é </a></li>
                        <li><a href="index.html#about">é—œæ–¼æˆ‘å€‘</a></li>
                        <li><a href="index.html#services">æœå‹™</a></li>
                        <li><a href="learn_status.html"  class="active" aria-current="page">å­¸ç¿’æ­·ç¨‹åˆ†æ</a></li>
                        <li><a href="/logout">ç™»å‡º</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h3>æ³•å¾‹è³‡è¨Š</h3>
                    <ul>
                      <li><a href="/views/privacy.html">éš±ç§æ¬Šæ”¿ç­–</a></li>
                      <li><a href="/views/tos.html">æœå‹™æ¢æ¬¾</a></li>
                    </ul>
                  </div>
                
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 è³‡è¨±ä½ å®‰å…¨. ä¿ç•™æ‰€æœ‰æ¬Šåˆ©.</p>
            </div>
        </div>
    </footer>

    <script>
        function isTokenExpired(token) {
        if (!token) return true;
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return Date.now() / 1000 > payload.exp;
        } catch {
            return true;
        }
        }

        const token = localStorage.getItem('token');
        if (!token || isTokenExpired(token)) {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // å–å¾—å­¸ç¿’æ­·ç¨‹è³‡æ–™
        async function fetchLearnStatus() {
            try {
                const res = await fetch('/api/profile/learn_status', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                const result = await res.json();
                if (result.success) {
                    const data = result.data;
                    renderCharts(data);
                    updateSummary(data);
                } else {
                    document.getElementById('summary-text').innerText = 'ç„¡æ³•å–å¾—å­¸ç¿’æ­·ç¨‹è³‡æ–™';
                }
            } catch (e) {
                document.getElementById('summary-text').innerText = 'è¼‰å…¥å­¸ç¿’æ­·ç¨‹å¤±æ•—';
                console.error('è¼‰å…¥å­¸ç¿’æ­·ç¨‹å¤±æ•—', e);
            }
        }

        // æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸ï¼šç§’ -> æ™‚:åˆ†:ç§’ æˆ– åˆ†:ç§’
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }

        // Context ID å°æ‡‰è¡¨
        const contextIdMapping = {
            2: 'æœƒè­°å®¤ç®¡ç†',
            4: 'ç„¡ç·šç¶²è·¯å®‰å…¨',
            6: 'å¤–ä¾†è£ç½®é¢¨éšª',
            71: 'å¯†ç¢¼å¼·åº¦',
            72: 'æ©Ÿå¯†æ–‡ä»¶ç®¡ç†',
            73: 'è³‡æ–™å¤–æ´©é¢¨éšª',
            74: 'æƒ¡æ„ç¶²ç«™',
            75: 'é‡£é­šéƒµä»¶é˜²ç¯„'
        };

        // Context ID æ ¼å¼åŒ–å‡½æ•¸ï¼šè½‰æ›ç‚ºä¸­æ–‡åç¨±
        function formatContextId(contextId) {
            return contextIdMapping[contextId] || `æƒ…å¢ƒ${contextId}`;
        }

        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•¸ï¼šå°‡ MySQL DATETIME è½‰æ›ç‚ºå¹´æœˆæ—¥æ ¼å¼
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥æ™‚é–“';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (e) {
                return 'ç„¡æ•ˆæ™‚é–“';
            }
        }

        // æ ¹æ“šè³‡æ–™æ¸²æŸ“åœ–è¡¨
        function renderCharts(data) {
            // context_id ä»£è¡¨é—œå¡ï¼Œerr_count ä»£è¡¨éŒ¯èª¤æ¬¡æ•¸ï¼Œtime_record ä»£è¡¨å­¸ç¿’æ™‚é–“
            const contextLabels = [...new Set(data.map(row => row.context_id))];
            const formattedContextLabels = contextLabels.map(label => formatContextId(label));
            
            // ç‚ºæ¯å€‹ context æº–å‚™è³‡æ–™å’Œå®Œæˆæ™‚é–“
            const contextData = contextLabels.map(label => {
                const contextRows = data.filter(row => row.context_id === label);
                const totalTime = contextRows.reduce((sum, row) => sum + (row.time_record || 0), 0);
                const totalErrors = contextRows.reduce((sum, row) => sum + row.err_count, 0);
                
                // æ‰¾åˆ°æœ€æ–°çš„è¨˜éŒ„ï¼ˆæ ¹æ“š created_atï¼‰
                const latestRecord = contextRows.reduce((latest, row) => {
                    return new Date(row.created_at) > new Date(latest.created_at) ? row : latest;
                }, contextRows[0]);
                
                // æ‰¾åˆ°æœ€ä½³è¨˜éŒ„ï¼ˆæœ€å°‘éŒ¯èª¤æ¬¡æ•¸ï¼‰
                const bestRecord = contextRows.reduce((best, row) => {
                    return row.err_count < best.err_count ? row : best;
                }, contextRows[0]);
                
                return {
                    contextId: label,
                    formattedId: formatContextId(label),
                    totalTime,
                    totalErrors,
                    completedAt: latestRecord.created_at,
                    latestErrorCount: latestRecord.err_count,  // æœ€æ–°è¨˜éŒ„çš„éŒ¯èª¤æ¬¡æ•¸
                    bestErrorCount: bestRecord.err_count,      // æœ€ä½³è¨˜éŒ„çš„éŒ¯èª¤æ¬¡æ•¸
                    isPerfectLatest: latestRecord.err_count === 0,  // æœ€æ–°è¨˜éŒ„æ˜¯å¦å®Œç¾
                    isPerfectBest: bestRecord.err_count === 0       // æ˜¯å¦æœ‰å®Œç¾è¨˜éŒ„
                };
            });
            
            const learningTimes = contextData.map(item => item.totalTime);
            const errorRates = contextData.map(item => item.totalErrors);

            // å„é—œå¡éŒ¯èª¤æ¬¡æ•¸åœ–è¡¨
            new Chart(document.getElementById('errorCountChart'), {
                type: 'bar',
                data: {
                    labels: formattedContextLabels,
                    datasets: [{
                        label: 'éŒ¯èª¤æ¬¡æ•¸',
                        data: errorRates,
                        backgroundColor: '#f43f5e',
                        borderColor: '#b91c1c',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            titleFont: {
                                size: 28
                            },
                            bodyFont: {
                                size: 24
                            },
                            padding: 20,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const contextInfo = contextData[index];
                                    return contextInfo.formattedId;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const contextInfo = contextData[index];
                                    const completedDate = formatDate(contextInfo.completedAt);
                                    return [
                                        `éŒ¯èª¤æ¬¡æ•¸: ${context.parsed.y}`,
                                        `å®Œæˆæ™‚é–“: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                }
            });

            // å„é—œå¡å­¸ç¿’æ™‚é–“åœ–è¡¨
            new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: {
                    labels: formattedContextLabels,
                    datasets: [{
                        label: 'å­¸ç¿’æ™‚é–“(åˆ†:ç§’)',
                        data: learningTimes,
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            titleFont: {
                                size: 28
                            },
                            bodyFont: {
                                size: 24
                            },
                            padding: 20,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const contextInfo = contextData[index];
                                    return contextInfo.formattedId;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const contextInfo = contextData[index];
                                    const seconds = context.parsed.y;
                                    const completedDate = formatDate(contextInfo.completedAt);
                                    return [
                                        `å­¸ç¿’æ™‚é–“: ${formatTime(seconds)}`,
                                        `å®Œæˆæ™‚é–“: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatTime(value);
                                }
                            }
                        }
                    }
                }
            });

            // éŒ¯èª¤æ¬¡æ•¸ vs å­¸ç¿’æ™‚é–“æ•£ä½ˆåœ–
            const scatterData = data.map(row => ({
                x: row.err_count,
                y: row.time_record,
                context_id: row.context_id
            }));

            // æŒ‰ context_id åˆ†çµ„é¡¯ç¤ºä¸åŒé¡è‰²
            const contexts = [...new Set(data.map(row => row.context_id))];
            const colors = ['#000000', '#FF2D2D', '#4DFFFF', '#00DB00', '#E1E100', '#0000E3', '#D3A4FF', '#7D4848'];
            
            const scatterDatasets = contexts.map((context, index) => ({
                label: formatContextId(context),
                data: scatterData.filter(point => point.context_id === context),
                backgroundColor: colors[index % colors.length],
                borderColor: colors[index % colors.length],
                pointRadius: 8,
                pointHoverRadius: 10
            }));

            new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: {
                    datasets: scatterDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'bottom' 
                        },
                        tooltip: {
                            titleFont: {
                                size: 28
                            },
                            bodyFont: {
                                size: 24
                            },
                            padding: 20,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    const datasetIndex = context[0].datasetIndex;
                                    const dataIndex = context[0].dataIndex;
                                    const dataset = scatterDatasets[datasetIndex];
                                    const dataPoint = dataset.data[dataIndex];
                                    const contextInfo = contextData.find(item => item.contextId === dataPoint.context_id);
                                    return contextInfo ? contextInfo.formattedId : formatContextId(dataPoint.context_id);
                                },
                                label: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const dataIndex = context.dataIndex;
                                    const dataset = scatterDatasets[datasetIndex];
                                    const dataPoint = dataset.data[dataIndex];
                                    const contextInfo = contextData.find(item => item.contextId === dataPoint.context_id);
                                    const point = context.parsed;
                                    const timeFormatted = formatTime(point.y);
                                    const completedDate = formatDate(contextInfo ? contextInfo.completedAt : '');
                                    return [
                                        `éŒ¯èª¤æ¬¡æ•¸: ${point.x}`,
                                        `å­¸ç¿’æ™‚é–“: ${timeFormatted}`,
                                        `å®Œæˆæ™‚é–“: ${completedDate}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'éŒ¯èª¤æ¬¡æ•¸'
                            },
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å­¸ç¿’æ™‚é–“'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatTime(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°å­¸ç¿’ç¸½çµ
        function updateSummary(data) {
            const totalTimeSeconds = data.reduce((sum, row) => sum + (row.time_record || 0), 0);
            const totalErr = data.reduce((sum, row) => sum + row.err_count, 0);
            const averageErrorRate = data.length > 0 ? Math.round(totalErr / data.length) : 0;
            const totalTimeFormatted = formatTime(totalTimeSeconds);
            
            // è¨ˆç®—çµ±è¨ˆè³‡æ–™
            const contextLabels = [...new Set(data.map(row => row.context_id))];
            const totalScenarios = contextLabels.length;
            
            // è¨ˆç®—å®Œç¾é€šé—œæ•¸é‡ï¼ˆéŒ¯èª¤æ¬¡æ•¸ç‚º0çš„æƒ…å¢ƒï¼‰
            const perfectScenarios = contextLabels.filter(contextId => {
                const contextRows = data.filter(row => row.context_id === contextId);
                const bestRecord = contextRows.reduce((best, row) => {
                    return row.err_count < best.err_count ? row : best;
                }, contextRows[0]);
                return bestRecord.err_count === 0;
            }).length;
            
            // è¨ˆç®—æŒæ¡åº¦ï¼ˆåŸºæ–¼éŒ¯èª¤æ¬¡æ•¸ï¼‰
            const masteryScore = totalScenarios > 0 ? Math.max(0, 100 - (averageErrorRate * 10)) : 0;
            
            // è¨ˆç®—æ•ˆç‡æŒ‡æ¨™ï¼ˆåŸºæ–¼æ™‚é–“å’ŒéŒ¯èª¤æ¬¡æ•¸çš„ç¶œåˆè©•ä¼°ï¼‰
            const avgTimePerScenario = totalScenarios > 0 ? totalTimeSeconds / totalScenarios : 0;
            const timeEfficiency = Math.max(0, 100 - (avgTimePerScenario / 60) * 5);
            const errorEfficiency = Math.max(0, 100 - averageErrorRate * 20);
            const overallEfficiency = (timeEfficiency + errorEfficiency) / 2;
            
            // ç”Ÿæˆçµ±è¨ˆç¸½è¦½è¡¨æ ¼
            generateSummaryStatsTable(totalScenarios, totalTimeFormatted, perfectScenarios, averageErrorRate, masteryScore, overallEfficiency);
            
            // ç”Ÿæˆå„æƒ…å¢ƒè©³ç´°è¡¨æ ¼
            generateScenariosDetailsTable(data, contextLabels);
            
            // ç”Ÿæˆæˆå°±è¡¨æ ¼
            generateAchievementsTable(data, totalScenarios, perfectScenarios, totalTimeSeconds, averageErrorRate);
            
            // ç”Ÿæˆå­¸ç¿’å»ºè­°
            generateRecommendations(data, totalTimeFormatted, averageErrorRate, totalScenarios, perfectScenarios, masteryScore, overallEfficiency);
        }
        
        // ç”Ÿæˆçµ±è¨ˆç¸½è¦½è¡¨æ ¼
        function generateSummaryStatsTable(totalScenarios, totalTime, perfectScenarios, avgErrors, masteryScore, efficiency) {
            const statsTableBody = document.getElementById('summary-stats-table');
            
            const stats = [
                {
                    item: 'å®Œæˆæƒ…å¢ƒæ•¸é‡',
                    value: `<span class="highlight-value">${totalScenarios}</span> å€‹`,
                    rating: getRating(totalScenarios, [8, 5, 3]),
                    description: 'å·²å®Œæˆçš„å­¸ç¿’æƒ…å¢ƒç¸½æ•¸'
                },
                {
                    item: 'ç¸½å­¸ç¿’æ™‚é–“',
                    value: `<span class="highlight-time">${totalTime}</span>`,
                    rating: getRating(parseInt(totalTime.split(':')[0]), [60, 30, 10]),
                    description: 'ç´¯è¨ˆæŠ•å…¥çš„å­¸ç¿’æ™‚é–“'
                },
                {
                    item: 'å®Œç¾é€šé—œ',
                    value: `<span class="highlight-value">${perfectScenarios}</span>/${totalScenarios}`,
                    rating: getRating(perfectScenarios, [5, 3, 1]),
                    description: 'é›¶éŒ¯èª¤å®Œæˆçš„æƒ…å¢ƒæ•¸é‡'
                },
                {
                    item: 'å¹³å‡éŒ¯èª¤æ¬¡æ•¸',
                    value: `<span class="highlight-error ${getErrorClass(avgErrors)}">${avgErrors}</span> æ¬¡`,
                    rating: getRating(5 - avgErrors, [4, 2, 1]),
                    description: 'æ¯å€‹æƒ…å¢ƒçš„å¹³å‡éŒ¯èª¤æ¬¡æ•¸'
                },
                {
                    item: 'æ•´é«”æŒæ¡åº¦',
                    value: `<span class="highlight-value">${Math.round(masteryScore)}</span>%`,
                    rating: getRating(masteryScore, [80, 60, 40]),
                    description: 'åŸºæ–¼éŒ¯èª¤æ¬¡æ•¸è¨ˆç®—çš„æŒæ¡ç¨‹åº¦'
                },
                {
                    item: 'å­¸ç¿’æ•ˆç‡',
                    value: `<span class="highlight-value">${Math.round(efficiency)}</span>%`,
                    rating: getRating(efficiency, [80, 60, 40]),
                    description: 'æ™‚é–“å’Œæº–ç¢ºåº¦çš„ç¶œåˆè©•ä¼°'
                }
            ];
            
            statsTableBody.innerHTML = stats.map(stat => `
                <tr>
                    <td><strong>${stat.item}</strong></td>
                    <td>${stat.value}</td>
                    <td><span class="${stat.rating.class}">${stat.rating.text}</span></td>
                    <td>${stat.description}</td>
                </tr>
            `).join('');
        }
        
        // ç”Ÿæˆå„æƒ…å¢ƒè©³ç´°è¡¨æ ¼
        function generateScenariosDetailsTable(data, contextLabels) {
            const scenariosTableBody = document.getElementById('scenarios-details-table');
            
            const scenarioDetails = contextLabels.map(contextId => {
                const contextRows = data.filter(row => row.context_id === contextId);
                const totalTime = contextRows.reduce((sum, row) => sum + (row.time_record || 0), 0);
                const completionCount = contextRows.length;
                
                const bestRecord = contextRows.reduce((best, row) => {
                    return row.err_count < best.err_count ? row : best;
                }, contextRows[0]);
                
                const latestRecord = contextRows.reduce((latest, row) => {
                    return new Date(row.created_at) > new Date(latest.created_at) ? row : latest;
                }, contextRows[0]);
                
                return {
                    name: formatContextId(contextId),
                    completionCount,
                    bestErrors: bestRecord.err_count,
                    latestErrors: latestRecord.err_count,
                    totalTime: formatTime(totalTime),
                    lastCompleted: formatDate(latestRecord.created_at),
                    status: getScenarioStatus(bestRecord.err_count, latestRecord.err_count)
                };
            });
            
            scenariosTableBody.innerHTML = scenarioDetails.map(scenario => `
                <tr>
                    <td><strong>${scenario.name}</strong></td>
                    <td><span class="highlight-value">${scenario.completionCount}</span> æ¬¡</td>
                    <td><span class="highlight-error ${getErrorClass(scenario.bestErrors)}">${scenario.bestErrors}</span> æ¬¡</td>
                    <td><span class="highlight-error ${getErrorClass(scenario.latestErrors)}">${scenario.latestErrors}</span> æ¬¡</td>
                    <td><span class="highlight-time">${scenario.totalTime}</span></td>
                    <td>${scenario.lastCompleted}</td>
                    <td><span class="${scenario.status.class}">${scenario.status.text}</span></td>
                </tr>
            `).join('');
        }
        
        // ç”Ÿæˆæˆå°±è¡¨æ ¼
        function generateAchievementsTable(data, totalScenarios, perfectScenarios, totalTimeSeconds, avgErrors) {
            const achievementsTableBody = document.getElementById('achievements-table');
            const achievements = [];
            
            // å®Œæˆæƒ…å¢ƒæˆå°±
            if (totalScenarios >= 8) {
                achievements.push({
                    type: 'æƒ…å¢ƒå®Œæˆ',
                    name: 'è³‡å®‰å°ˆå®¶',
                    level: 'gold',
                    condition: 'å®Œæˆæ‰€æœ‰ 8 å€‹å­¸ç¿’æƒ…å¢ƒ'
                });
            } else if (totalScenarios >= 5) {
                achievements.push({
                    type: 'æƒ…å¢ƒå®Œæˆ',
                    name: 'æƒ…å¢ƒæ¢ç´¢è€…',
                    level: 'silver',
                    condition: `å®Œæˆ ${totalScenarios} å€‹å­¸ç¿’æƒ…å¢ƒ`
                });
            } else if (totalScenarios >= 3) {
                achievements.push({
                    type: 'æƒ…å¢ƒå®Œæˆ',
                    name: 'å­¸ç¿’æ–°æ‰‹',
                    level: 'bronze',
                    condition: `å®Œæˆ ${totalScenarios} å€‹å­¸ç¿’æƒ…å¢ƒ`
                });
            }
            
            // å®Œç¾é€šé—œæˆå°±
            if (perfectScenarios >= 5) {
                achievements.push({
                    type: 'å®Œç¾é€šé—œ',
                    name: 'å®Œç¾ä¸»ç¾©è€…',
                    level: 'gold',
                    condition: `${perfectScenarios} æ¬¡å®Œç¾é€šé—œ`
                });
            } else if (perfectScenarios >= 3) {
                achievements.push({
                    type: 'å®Œç¾é€šé—œ',
                    name: 'ç²¾æº–å°„æ‰‹',
                    level: 'silver',
                    condition: `${perfectScenarios} æ¬¡å®Œç¾é€šé—œ`
                });
            } else if (perfectScenarios >= 1) {
                achievements.push({
                    type: 'å®Œç¾é€šé—œ',
                    name: 'åˆéœ²é‹’èŠ’',
                    level: 'bronze',
                    condition: `${perfectScenarios} æ¬¡å®Œç¾é€šé—œ`
                });
            }
            
            // å­¸ç¿’æ™‚é–“æˆå°±
            const totalMinutes = Math.floor(totalTimeSeconds / 60);
            if (totalMinutes >= 60) {
                achievements.push({
                    type: 'å­¸ç¿’æ™‚é–“',
                    name: 'å­¸ç¿’é¦¬æ‹‰æ¾',
                    level: 'gold',
                    condition: 'ç´¯è¨ˆå­¸ç¿’è¶…é 1 å°æ™‚'
                });
            } else if (totalMinutes >= 30) {
                achievements.push({
                    type: 'å­¸ç¿’æ™‚é–“',
                    name: 'å°ˆæ³¨å­¸ç¿’è€…',
                    level: 'silver',
                    condition: 'ç´¯è¨ˆå­¸ç¿’è¶…é 30 åˆ†é˜'
                });
            } else if (totalMinutes >= 10) {
                achievements.push({
                    type: 'å­¸ç¿’æ™‚é–“',
                    name: 'æ™‚é–“æŠ•è³‡è€…',
                    level: 'bronze',
                    condition: 'ç´¯è¨ˆå­¸ç¿’è¶…é 10 åˆ†é˜'
                });
            }
            
            // éŒ¯èª¤ç‡æˆå°±
            if (avgErrors <= 1) {
                achievements.push({
                    type: 'æº–ç¢ºåº¦',
                    name: 'ç¥å°„æ‰‹',
                    level: 'gold',
                    condition: 'å¹³å‡éŒ¯èª¤æ¬¡æ•¸ â‰¤ 1'
                });
            } else if (avgErrors <= 2) {
                achievements.push({
                    type: 'æº–ç¢ºåº¦',
                    name: 'æº–ç¢ºå°„æ‰‹',
                    level: 'silver',
                    condition: 'å¹³å‡éŒ¯èª¤æ¬¡æ•¸ â‰¤ 2'
                });
            }
            
            if (achievements.length === 0) {
                achievementsTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--gray-500); font-style: italic;">ç¹¼çºŒå­¸ç¿’ä»¥è§£é–æ›´å¤šæˆå°±ï¼</td></tr>';
            } else {
                achievementsTableBody.innerHTML = achievements.map(achievement => `
                    <tr>
                        <td><strong>${achievement.type}</strong></td>
                        <td>${achievement.name}</td>
                        <td><span class="achievement-${achievement.level}">${getLevelIcon(achievement.level)} ${getLevelText(achievement.level)}</span></td>
                        <td>${achievement.condition}</td>
                    </tr>
                `).join('');
            }
        }
        
        // ç”Ÿæˆå­¸ç¿’å»ºè­°
        function generateRecommendations(data, totalTime, avgErrors, totalScenarios, perfectScenarios, masteryScore, efficiency) {
            const recommendationText = document.getElementById('recommendation-text');
            
            let recommendations = `<strong>ğŸ“Š å­¸ç¿’æ¦‚æ³ï¼š</strong><br>`;
            recommendations += `ä½ ç¸½å…±å®Œæˆäº† <span class="highlight-value">${totalScenarios}</span> å€‹è³‡å®‰æƒ…å¢ƒçš„å­¸ç¿’ï¼Œç´¯è¨ˆå­¸ç¿’æ™‚é–“ç‚º <span class="highlight-time">${totalTime}</span>ã€‚<br><br>`;
            
            recommendations += `<strong>ğŸ¯ è¡¨ç¾åˆ†æï¼š</strong><br>`;
            if (perfectScenarios > 0) {
                recommendations += `ğŸ‰ æ­å–œï¼ä½ åœ¨ <span class="highlight-value">${perfectScenarios}</span> å€‹æƒ…å¢ƒä¸­é”åˆ°äº†å®Œç¾é€šé—œï¼ˆé›¶éŒ¯èª¤ï¼‰ï¼<br>`;
            }
            
            recommendations += `å¹³å‡æ¯å€‹æƒ…å¢ƒçš„éŒ¯èª¤æ¬¡æ•¸ç‚º <span class="highlight-error ${getErrorClass(avgErrors)}">${avgErrors}</span> æ¬¡ã€‚<br><br>`;
            
            recommendations += `<strong>ğŸ’¡ å­¸ç¿’å»ºè­°ï¼š</strong><br>`;
            if (masteryScore >= 80) {
                recommendations += `ğŸŒŸ <strong>å„ªç§€è¡¨ç¾ï¼š</strong>ä½ çš„æŒæ¡åº¦é”åˆ°äº† ${Math.round(masteryScore)}%ï¼Œè¡¨ç¾éå¸¸å‡ºè‰²ï¼å»ºè­°æŒ‘æˆ°æ›´é«˜é›£åº¦çš„è³‡å®‰æƒ…å¢ƒæˆ–æ·±å…¥å­¸ç¿’ç›¸é—œç†è«–çŸ¥è­˜ã€‚`;
            } else if (masteryScore >= 60) {
                recommendations += `ğŸ“ˆ <strong>è‰¯å¥½é€²æ­¥ï¼š</strong>ä½ çš„æŒæ¡åº¦ç‚º ${Math.round(masteryScore)}%ï¼Œå·²ç¶“æœ‰äº†ä¸éŒ¯çš„åŸºç¤ã€‚å»ºè­°é‡é»è¤‡ç¿’éŒ¯èª¤è¼ƒå¤šçš„æƒ…å¢ƒï¼Œä¸¦åŠ å¼·ç›¸é—œæ¦‚å¿µçš„ç†è§£ã€‚`;
            } else {
                recommendations += `ğŸ’ª <strong>æŒçºŒåŠªåŠ›ï¼š</strong>ä½ çš„æŒæ¡åº¦ç‚º ${Math.round(masteryScore)}%ï¼Œé‚„æœ‰å¾ˆå¤§çš„æå‡ç©ºé–“ã€‚å»ºè­°é‡è¤‡ç·´ç¿’åŸºç¤æƒ…å¢ƒï¼Œä»”ç´°é–±è®€ç›¸é—œè³‡å®‰çŸ¥è­˜ï¼Œä¸¦å°‹æ±‚é¡å¤–çš„å­¸ç¿’è³‡æºã€‚`;
            }
            
            recommendationText.innerHTML = recommendations;
        }
        
        // è¼”åŠ©å‡½æ•¸
        function getRating(value, thresholds) {
            if (value >= thresholds[0]) {
                return { class: 'rating-excellent', text: 'å„ªç§€' };
            } else if (value >= thresholds[1]) {
                return { class: 'rating-good', text: 'è‰¯å¥½' };
            } else if (value >= thresholds[2]) {
                return { class: 'rating-average', text: 'ä¸€èˆ¬' };
            } else {
                return { class: 'rating-poor', text: 'å¾…æ”¹é€²' };
            }
        }
        
        function getErrorClass(errors) {
            if (errors <= 1) return 'low';
            if (errors <= 3) return 'medium';
            return 'high';
        }
        
        function getScenarioStatus(bestErrors, latestErrors) {
            if (bestErrors === 0) {
                return { class: 'status-perfect', text: 'å®Œç¾æŒæ¡' };
            } else if (latestErrors <= bestErrors) {
                return { class: 'status-good', text: 'æŒçºŒé€²æ­¥' };
            } else if (latestErrors <= 2) {
                return { class: 'status-average', text: 'è¡¨ç¾è‰¯å¥½' };
            } else {
                return { class: 'status-needs-improvement', text: 'éœ€è¦åŠ å¼·' };
            }
        }
        
        function getLevelIcon(level) {
            switch(level) {
                case 'gold': return 'ğŸ†';
                case 'silver': return 'ğŸ¥ˆ';
                case 'bronze': return 'ğŸ¥‰';
                default: return 'ğŸ…';
            }
        }
        
        function getLevelText(level) {
            switch(level) {
                case 'gold': return 'é‡‘ç´š';
                case 'silver': return 'éŠ€ç´š';
                case 'bronze': return 'éŠ…ç´š';
                default: return 'æ™®é€š';
            }
        }

        // åˆå§‹åŒ–
        fetchLearnStatus();
    </script>
</body>
</html>